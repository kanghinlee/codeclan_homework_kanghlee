---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(here)
library(readxl)
library(stringr)
library(naniar)
library(janitor)
```

```{r}
raw_15 <- read_csv("clean_data/clean_main_15.csv")
raw_16 <- read_csv("clean_data/clean_main_16.csv")
raw_17 <- read_csv("clean_data/clean_main_17.csv")

main_15 <- raw_15
main_16 <- raw_16
main_17 <- raw_17
```

## For consistency, adding additional columns 'gender, country, county' to main_15.
```{r}
main_15$gender <- NA
main_15$country <- NA
main_15$province_n_county <- NA

main_15 <-  relocate(main_15,province_n_county, .after = age)
main_15 <-  relocate(main_15,country, .after = age)
main_15 <-  relocate(main_15,gender, .after = age)
```



## Task 4 - Question 1 - What is the total number of candy ratings given across 
## the three years (Exclud. NAs)
```{r}
Cand_count_2015 <- sum(!is.na(main_15[7:ncol(main_15)]))
Cand_count_2016 <- sum(!is.na(main_16[7:ncol(main_16)]))
Cand_count_2017 <- sum(!is.na(main_17[7:ncol(main_17)]))
Cand_count = Cand_count_2015+Cand_count_2016+Cand_count_2017
Cand_count
```

## Task 4 - Question 2 - What was the average age of people who are going out 
## trick or treating and the average age of people not going trick or treating?

```{r}
tri_o_tre_15 <- select(main_15, c(going_out, age))
tri_o_tre_16 <- select(main_16, c(going_out, age))
tri_o_tre_17 <- select(main_17, c(going_out, age))

tri_o_tre_tot <- rbind(tri_o_tre_17, tri_o_tre_16)
  tri_o_tre_tot <- rbind (tri_o_tre_tot, tri_o_tre_15) %>% 
  group_by(going_out) %>%
  summarise(avg_age = mean(age, na.rm = TRUE)) 
  
names(tri_o_tre_tot)[names(tri_o_tre_tot)== "going_out"] <- "going_out_trick_or_treat"
tri_o_tre_tot
```
## Task 4 - Question 3 - How many people rated Starburst as despair?

```{r}
# Checking what are the difference in column names in the 3 dataframes.
# diff_colnam <- compare_df_cols(main_15, main_16, main_17, return = "match") 
names(main_17)[names(main_17)== "anonymous_brown_globs_that_come_in_black_and_orange_wrappers_a_k_a_mary_janes"] <- "anonymous_brown_globs_that_come_in_black_and_orange_wrappers"
names(main_17)[names(main_17)== "100_grand_bar"] <- "x100_grand_bar"
names(main_15)[names(main_15)== "box_o_raisins"] <- "boxo_raisins"


#Merge Dataframes
main_tot <- merge(main_17, main_16, all = TRUE)
main_tot <- merge(main_tot, main_15, all = TRUE)

rating_count <- main_tot[4:ncol(main_tot)] %>% 
  summarise_all(~ sum(!is.na(.)))

rating_count <- as.data.frame(t(rating_count))

#extract rownames then join rating_count as column
sweet_name <- str_to_title(rownames(rating_count))
rownames(rating_count) <- NULL
rating_count <- cbind(sweet_name, rating_count)

#remove rowname


colnames(rating_count)[1] <- "sweet_name"
colnames(rating_count)[2] <- "rating"

Max_rating_sweet <- slice_max(rating_count, rating)
Max_rating_sweet
```

## Task 4 - Question 4 - How many people rated Starburst as despair?
```{r}
star_despair <- main_tot %>% 
    filter(starburst == "DESPAIR")

nrow(star_despair)
```


## (Unfinish)Task 4 - Question 5 - For the next three questions, count despair as -1, joy as +1 and meh as 0.


```{r}
neg_num <- function(x) -1*abs(x)

```

```{r}
# val_tot <- t(val_tot)
# 
# rat_num_tot <- setNames(data.frame(matrix(ncol = ncol(val_tot), nrow = nrow(val_tot))), c("V1"))
# colnames(rat_num_tot) <- colnames(val_tot)
# rownames(rat_num_tot) <- rownames(val_tot)
# 
# for (x in 1:ncol(val_tot)) {
#   for (y in 1:nrow(val_tot)) {
#     if (is.na(val_tot[x, y]) == TRUE || is.null(val_tot[x,y]) == TRUE) {
#       rat_num_tot[x, y] <- NA
#     } else if (val_tot[x, y] == 'MEH') {
#       rat_num_tot[x, y] <- 0
#     } else if (val_tot[x, y] == 'JOY') {
#        rat_num_tot[x, y] <- 1     
#     }   else if (val_tot[x, y] == 'DESPAIR') {
#       rat_num_tot[x, y] <- neg_num(1)
#     }      else {
#       rat_num_tot[x, y] <- val_tot[x, y]
#     }
#   }
# }


val_main_15 <- (t(main_15[-c(2, 3, 6)]))

des_15 <- setNames(data.frame(matrix(ncol = ncol(val_main_15), nrow = nrow(val_main_15))), c("V1"))
colnames(des_15) <- colnames(val_main_15)
rownames(des_15) <- rownames(val_main_15)

for (x in 1 : ncol(val_main_15)) {
for (y in 1 : nrow(val_main_15)) {
  if (is.na(val_main_15[x,y]) == TRUE) {
    des_15[x,y] <- NA
    } else {
if (val_main_15[x,y] == 'MEH') {
  des_15[x,y] <- 0
} else if (val_main_15[x,y] == 'JOY') {
  des_15[x,y] <- 1
}   else if (val_main_15[x,y] == 'DESPAIR'){
    des_15[x,y] <- neg_num(1)
}      else {
  des_15[x,y] <- val_main_15[x,y]
}}
}
}


```

```{r}

val_main_16 <- t(main_16[-c(2, 3,6)])


des_16 <- setNames(data.frame(matrix(ncol = ncol(val_main_16), nrow = nrow(val_main_16))), c("V1"))
joy_16 <- setNames(data.frame(matrix(ncol = ncol(val_main_16), nrow = nrow(val_main_16))), c("V1"))
meh_16 <- setNames(data.frame(matrix(ncol = ncol(val_main_16), nrow = nrow(val_main_16))), c("V1"))

colnames(des_16) <- colnames(val_main_16)
rownames(des_16) <- rownames(val_main_16)
colnames(joy_16) <- colnames(val_main_16)
rownames(joy_16) <- rownames(val_main_16)
colnames(meh_16) <- colnames(val_main_16)
rownames(meh_16) <- rownames(val_main_16)


for (x in 1 : ncol(val_main_16)) {
for (y in 1 : nrow(val_main_16)) {
  if (is.na(val_main_16[x,y]) == TRUE) {
    des_16[x,y] <- NA;
    joy_16[x,y] <- NA;
    meh_16[x,y] <- NA
    } else {
if (val_main_16[x,y] == 'MEH') {
  des_16[x,y] <- 0;
  joy_16[x,y] <- 0;
  meh_16[x,y] <- 1
} else if (val_main_16[x,y] == 'JOY') {
  des_16[x,y] <- 0;
  joy_16[x,y] <- 1;
  meh_16[x,y] <- 0
}   else if (val_main_16[x,y] == 'DESPAIR'){
    des_16[x,y] <- 1;
    joy_16[x,y] <- 0;
    meh_16[x,y] <- 0
}      else {
  des_16[x,y] <- val_main_16[x,y];
  joy_16[x,y] <- val_main_16[x,y];
  meh_16[x,y] <- val_main_16[x,y]
}}
}
}

```
```{r}
val_main_17 <- t(main_17[-c(2, 3,6)])


des_17 <- setNames(data.frame(matrix(ncol = ncol(val_main_17), nrow = nrow(val_main_17))), c("V1"))
colnames(des_17) <- colnames(val_main_17)
rownames(des_17) <- rownames(val_main_17)

for (x in 1 : ncol(val_main_17)) {
for (y in 1 : nrow(val_main_17)) {
  if (is.na(val_main_17[x,y]) == TRUE) {
    des_17[x,y] <- NA
    } else {
if (val_main_17[x,y] == 'MEH') {
  des_17[x,y] <- 0
} else if (val_main_17[x,y] == 'JOY') {
  des_17[x,y] <- 1
}   else if (val_main_17[x,y] == 'DESPAIR'){
    des_17[x,y] <- neg_num(1)
  
}      else {
  des_17[x,y] <- val_main_17[x,y]
}}
}
}
```
## Task 4 -  Question 6 - What was the most popular candy bar by this rating system for each gender in the dataset?
```{r}
gend_des_16 <- des_16[-c(1,3),]
gend_joy_16 <- joy_16[-c(1,3),]
gend_meh_16 <- meh_16[-c(1,3),]

gend_des_16 <- as.data.frame(t(gend_des_16))
gend_joy_16 <- as.data.frame(t(gend_joy_16))
gend_meh_16 <- as.data.frame(t(gend_meh_16))

gend_des_16[2:ncol(gend_des_16)] <- as.numeric(unlist(gend_des_16[2:ncol(gend_des_16)]))
gend_joy_16[2:ncol(gend_joy_16)] <- as.numeric(unlist(gend_joy_16[2:ncol(gend_joy_16)]))
gend_meh_16[2:ncol(gend_meh_16)] <- as.numeric(unlist(gend_meh_16[2:ncol(gend_meh_16)]))


gend_16_joyrat <- gend_joy_16 %>% 
  group_by(gender) %>%
  summarise_all(sum, na.rm=TRUE)

gend_16_meh <- gend_meh_16 %>% 
  group_by(gender) %>%
  summarise_all(sum, na.rm=TRUE)

gend_16_desrat <- gend_des_16 %>% 
  group_by(gender) %>%
  summarise_all(sum, na.rm=TRUE)
gend_16_desrat[2:ncol(gend_16_desrat)] <- (gend_16_desrat[2:ncol(gend_16_desrat)]*-1)


gend_16_rattot <- setNames(data.frame(matrix(ncol = ncol(gend_16_joyrat), nrow = nrow(gend_16_joyrat))), c("V1"))

colnames(gend_16_rattot) <- colnames(gend_16_joyrat)
rownames(gend_16_rattot) <- rownames(gend_16_joyrat)
gend_16_rattot[,1] <- gend_16_joyrat[,1]

for (x in 2 : ncol(gend_16_joyrat)) {
for (y in 1 : nrow(gend_16_joyrat)-1) {
  gend_16_rattot[y,x] <- gend_16_joyrat[y,x] + gend_16_desrat[y,x]
}
}
gend_16_rattot <- gend_16_rattot[-c(5),]
  rownames(gend_16_rattot) <- gend_16_rattot[,1] 
  gend_16_rattot[,1] <- NULL
  

gend_16_rattot %>% filter(gender == "Female") %>% arrange()
  
```

